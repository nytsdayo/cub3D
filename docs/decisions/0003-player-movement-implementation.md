# ADR-0003: プレイヤー移動・回転の実装方針

## ステータス

**承認済み** (2025-12-07)

## コンテキスト

cub3Dプロジェクトでプレイヤーの移動と回転機能を実装する必要がある。以下の要件を満たす必要がある：

1. WASD キーによる前後左右の移動
2. 矢印キーによる視点の左右回転
3. 壁との衝突判定
4. 42 Norm 準拠（5関数/ファイル、25行/関数など）
5. パフォーマンス（毎フレーム呼ばれる）

## 検討した選択肢

### 選択肢 1: すべての処理を cleanup.c の handle_keypress() に統合

**利点:**
- ファイル数が少ない
- シンプルな構造

**欠点:**
- 1ファイルが肥大化し、Norm 違反のリスク
- 責務の分離ができない
- テストが困難
- 拡張性が低い

### 選択肢 2: player モジュールとして分離（採用）

**利点:**
- 単一責任原則に従う
- 各関数が簡潔で理解しやすい
- Norm 準拠しやすい（関数分割）
- テストが容易
- 拡張性が高い（ジャンプ、スプリントなど追加可能）

**欠点:**
- ファイル数が増える
- モジュール間の依存関係が発生

### 選択肢 3: 移動と回転を別々のファイルに分離（採用）

**利点:**
- 機能ごとの責務が明確
- 移動処理（4関数）と回転処理（2関数）で5関数/ファイル制限を守りやすい
- 独立してテスト・修正可能

**欠点:**
- ファイル数がさらに増える

## 決定

**選択肢 2 と 3 を組み合わせる**: `player` モジュールとして独立させ、移動と回転を別ファイルに分離する。

### 実装詳細

#### ファイル構成

```
srcs/engine/player/
├── player_movement.c   # 移動処理（5関数）
│   ├── move_forward()
│   ├── move_backward()
│   ├── move_left()
│   ├── move_right()
│   └── is_valid_position() (static)
└── player_rotation.c   # 回転処理（2関数）
    ├── rotate_left()
    └── rotate_right()

includes/engine/
└── player.h            # 公開関数プロトタイプ
```

#### 移動方式

- **前後移動**: 方向ベクトル (`dir_x`, `dir_y`) に沿って移動
- **左右移動（ストレイフ）**: カメラ平面 (`plane_x`, `plane_y`) に沿って移動
  - 理由: FPS ゲームの標準的な挙動に合わせる

#### 回転方式

- **回転行列**: `cos(θ)` と `sin(θ)` を使った2D回転行列
  - 方向ベクトルとカメラ平面を同時に回転
  - 数学的に正確で、浮動小数点誤差が累積しにくい

#### 衝突判定

- **方針**: 移動先の位置を事前チェック
- **実装**: `is_valid_position(game, x, y)` (static関数)
  - マップ範囲外チェック
  - 壁チェック（`world_map[y][x] != 0`）
  - 有効な場合のみ位置更新

#### 定数

```c
#define MOVE_SPEED 0.1   // 移動速度
#define ROT_SPEED 0.05   // 回転速度（ラジアン）
```

これらは `cub3d.h` で定義し、プロジェクト全体で共有。

## 結果

### 正の影響

1. **Norm 準拠**:
   - 各ファイルは5関数以下
   - 各関数は25行以下
   - Norminette チェック合格

2. **保守性向上**:
   - 機能ごとにファイルが分かれているため、修正範囲が明確
   - テストが容易

3. **拡張性**:
   - ジャンプ、スプリント、しゃがみなどを追加しやすい
   - マウス回転の追加も容易

4. **パフォーマンス**:
   - 衝突判定は単純な配列アクセスのみ（高速）
   - 回転時のみ `cos()` / `sin()` を計算（移動時は不要）

### 負の影響

1. **ファイル数増加**:
   - プロジェクトのファイル数が増える
   - 軽微（player/ ディレクトリで整理）

2. **依存関係**:
   - `player.h` のインクルード管理が必要
   - cleanup.c から player 関数を呼び出す依存が発生

### 対処策

- ディレクトリ構造で整理（`srcs/engine/player/`）
- ヘッダーファイルで API を明確化
- ドキュメント化（design.md, README.md）

## 関連決定

- [ADR-0002: main.cのリファクタリング](./0002-main-refactoring-separation-of-concerns.md)
  - エンジンモジュールの分離方針に従う

## 参照

- [player モジュール設計](../design/modules/engine/player/design.md)
- [engine モジュール設計](../design/modules/engine/design.md)
- [Lode's Raycasting Tutorial - Input](https://lodev.org/cgtutor/raycasting.html)
- [42 Norm](https://github.com/42School/norminette)

## メモ

- パーサー統合後、ハードコードされたマップ (`mock_world.c`) からパーサーが読み込んだマップに切り替え予定
- 初期位置の問題（壁の中に配置）を修正済み：(4.5, 4.5) → (3.5, 3.5)