# ADR-0003: プレイヤー移動・回転の実装方針

## ステータス

**承認済み** (2025-12-07)

## コンテキスト

cub3Dプロジェクトでプレイヤーの移動と回転機能を実装する必要がある。以下の要件を満たす必要がある：

1. WASD キーによる前後左右の移動
2. 矢印キーによる視点の左右回転
3. 壁との衝突判定
4. 42 Norm 準拠（5関数/ファイル、25行/関数など）
5. パフォーマンス（毎フレーム呼ばれる）

## 検討した選択肢

### 選択肢 1: すべての処理を cleanup.c の handle_keypress() に統合

**利点:**
- ファイル数が少ない
- シンプルな構造

**欠点:**
- 1ファイルが肥大化し、Norm 違反のリスク
- 責務の分離ができない
- テストが困難
- 拡張性が低い

### 選択肢 2: player モジュールとして分離（採用）

**利点:**
- 単一責任原則に従う
- 各関数が簡潔で理解しやすい
- Norm 準拠しやすい（関数分割）
- テストが容易
- 拡張性が高い（ジャンプ、スプリントなど追加可能）

**欠点:**
- ファイル数が増える
- モジュール間の依存関係が発生

### 選択肢 3: 移動と回転を別々のファイルに分離（採用）

**利点:**
- 機能ごとの責務が明確
- 移動処理（4関数）と回転処理（2関数）で5関数/ファイル制限を守りやすい
- 独立してテスト・修正可能

**欠点:**
- ファイル数がさらに増える

### 選択肢 4: 入力処理を専用モジュールに分離（採用）

**利点:**
- cleanup.cの責務を明確化（クリーンアップのみ）
- 入力処理の拡張が容易（マウス入力など）
- 単一責任原則に従う

**欠点:**
- ファイル数が増える
- モジュール間の依存関係が発生

### 選択肢 5: 連続キー押下処理の実装方式

#### 方式A: mlx_key_hookでキー押下のたびに処理（不採用）

**欠点:**
- キーリピート率がOSやMLX実装に依存
- スムーズな移動が困難

#### 方式B: キー状態配列 + 毎フレーム処理（採用）

**利点:**
- フレームレートに同期した安定した動作
- 複数キー同時押しに対応
- 動きがスムーズ

**実装:**
- `keys[256]`配列でキー状態を追跡
- `mlx_hook`でpress/releaseイベントを監視
- `process_held_keys()`を毎フレーム呼び出し

## 決定

以下の方針を採用：
- **選択肢 2, 3**: `player` モジュールとして独立させ、移動と回転を別ファイルに分離
- **選択肢 4**: 入力処理を `key_handler` モジュールに分離
- **選択肢 5B**: キー状態配列 + 毎フレーム処理方式

### 実装詳細

#### ファイル構成

```
srcs/engine/
├── key_handler/
│   └── key_handler.c              # 入力処理（4関数）
│       ├── handle_keypress()
│       ├── handle_keyrelease()
│       ├── process_held_keys()
│       └── close_window()
└── player/
    ├── player_movement.c    # 移動処理（5関数）
    │   ├── move_forward()
    │   ├── move_backward()
    │   ├── move_left()
    │   ├── move_right()
    │   └── is_wall() (static)
    └── player_rotation.c    # 回転処理（2関数）
        ├── rotate_left()
        └── rotate_right()

includes/engine/
├── key_handler.h              # 入力処理の関数プロトタイプ
└── player.h             # プレイヤー操作の関数プロトタイプ
```

#### 移動方式

- **前後移動**: 方向ベクトル (`dir_x`, `dir_y`) に沿って移動
- **左右移動（ストレイフ）**: カメラ平面 (`plane_x`, `plane_y`) に沿って移動
  - 理由: FPS ゲームの標準的な挙動に合わせる

#### 回転方式

- **回転行列**: `cos(θ)` と `sin(θ)` を使った2D回転行列
  - 方向ベクトルとカメラ平面を同時に回転
  - 数学的に正確で、浮動小数点誤差が累積しにくい

#### 入力処理

- **キー状態管理**: `game->keys[256]` 配列でキーの押下状態を追跡
- **イベントハンドリング**:
  - `mlx_hook(ON_KEYDOWN)` → `handle_keypress()`: キーを押したときに配列を1に設定
  - `mlx_hook(ON_KEYUP)` → `handle_keyrelease()`: キーを離したときに配列を0に設定
- **フレームごとの処理**:
  - `process_held_keys()` を `render_frame()` 内で毎フレーム呼び出し
  - 押されているキーに対応する移動・回転関数を実行

#### 衝突判定

- **方針**: 移動先の位置を事前チェック
- **実装**: `is_wall(game, x, y)` (static関数)
  - マップ範囲外チェック
  - バウンディングボックス4コーナーをチェック（壁へのクリッピング防止）
  - 壁チェック（`world_map[y][x] != 0`）
  - X/Y軸を個別にチェックして壁に沿ってスライド可能に

#### X/Y軸分離チェック

各移動関数で、X軸とY軸の衝突判定を個別に行う：

```c
if (!is_wall(game, new_x, current_y))
    pos_x = new_x;  // X軸のみ移動
if (!is_wall(game, current_x, new_y))
    pos_y = new_y;  // Y軸のみ移動
```

これにより、斜めに壁に当たった際も壁に沿ってスライドできる。

#### 定数

```c
#define MOVE_SPEED 0.1           // 移動速度
#define ROT_SPEED 0.05           // 回転速度（ラジアン）
#define COLLISION_MARGIN 0.2     // プレイヤーの当たり判定マージン
```

これらは `cub3d.h` で定義し、プロジェクト全体で共有。

## 結果

### 正の影響

1. **Norm 準拠**:
   - 各ファイルは5関数以下
   - 各関数は25行以下
   - Norminette チェック合格

2. **保守性向上**:
   - 機能ごとにファイルが分かれているため、修正範囲が明確
   - テストが容易

3. **拡張性**:
   - ジャンプ、スプリント、しゃがみなどを追加しやすい
   - マウス回転の追加も容易

4. **パフォーマンス**:
   - 衝突判定は単純な配列アクセスのみ（高速）
   - 回転時のみ `cos()` / `sin()` を計算（移動時は不要）

### 負の影響

1. **ファイル数増加**:
   - プロジェクトのファイル数が増える
   - 軽微（player/ ディレクトリで整理）

2. **依存関係**:
   - `player.h` のインクルード管理が必要
   - cleanup.c から player 関数を呼び出す依存が発生

### 対処策

- ディレクトリ構造で整理（`srcs/engine/player/`）
- ヘッダーファイルで API を明確化
- ドキュメント化（design.md, README.md）

## 関連決定

- [ADR-0002: main.cのリファクタリング](./0002-main-refactoring-separation-of-concerns.md)
  - エンジンモジュールの分離方針に従う

## 参照

- [key_handler モジュール設計](../design/modules/engine/key_handler/design.md)
- [player モジュール設計](../design/modules/engine/player/design.md)
- [engine モジュール設計](../design/modules/engine/design.md)
- [Lode's Raycasting Tutorial - Input](https://lodev.org/cgtutor/raycasting.html)
- [42 Norm](https://github.com/42School/norminette)

## メモ

- パーサー統合後、ハードコードされたマップ (`mock_world.c`) からパーサーが読み込んだマップに切り替え予定
- 初期位置の問題（壁の中に配置）を修正済み：(4.5, 4.5) → (3.5, 3.5)

### 実装後の改善履歴

- **2025-12-15**: 入力処理モジュール分離 (d40be28)
  - cleanup.c から入力処理を key_handler.c に移動
- **2025-12-15**: 画像クリーンアップ追加 (330357c)
  - メモリリーク修正（mlx_destroy_image 追加）
- **2025-12-15**: 衝突判定改善 (502f773)
  - COLLISION_MARGIN 追加、4コーナーチェック、X/Y軸分離
  - is_valid_position → is_wall にリネーム
- **2025-12-15**: 連続キー押下処理実装 (a074e35)
  - keys[256] 配列とフレームごとの処理を追加