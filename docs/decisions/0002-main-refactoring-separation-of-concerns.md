# ADR-0002: main.cのリファクタリング - 関心の分離

## ステータス

提案中

## コンテキスト

現在の`main.c`には以下の複数の責務が混在している：

1. 引数検証（`valid_args`）
2. マップファイルの読み込み（`read_map`）
3. マップのパース（`parse`）
4. ゲーム構造体の初期化（`init_game`）
5. **イベントフックの設定**（`mlx_key_hook`, `mlx_hook`, `mlx_loop_hook`）
6. **メインゲームループの起動**（`mlx_loop`）
7. クリーンアップ（`cleanup_game`）

特に問題となるのは、5と6の責務が`main.c`に直接記述されている点である。これにより：
- `main.c`の責務が過剰になっている（単一責任原則違反）
- エンジンの制御フローが`main.c`に依存している（依存性逆転原則違反）
- ゲームループの詳細が`main`関数内に露出している

## 決定

以下のリファクタリングを実施する：

### 1. ゲームループモジュールの作成
`srcs/engine/game_loop.c`を新規作成し、以下の機能を実装：
- `setup_event_hooks()` - イベントフックの設定を集約
- `run_game_loop()` - ゲームループの起動・実行・クリーンアップを管理

### 2. main.cの簡略化
`main.c`は高レベルのオーケストレーションのみを担当：
```c
int main(int argc, char *argv[]) {
  t_game game;

  // 1. 検証
  if (valid_args(argc, argv) != 0)
    return (EXIT_FAILURE);

  // 2. データ読み込み
  game.map = (char **)read_map(argv[1]);
  if (game.map == NULL) {
    write(2, "Error\nFailed to read map\n", 25);
    return (EXIT_FAILURE);
  }

  // 3. パース
  if (parse((const char **)game.map) != 0)
    return (EXIT_FAILURE);

  // 4. 初期化
  init_game(&game);

  // 5. ゲームループ起動（詳細はengine/game_loop.cに委譲）
  run_game_loop(&game);

  return (EXIT_SUCCESS);
}
```

### 3. ヘッダーの更新
`includes/engine/engine.h`に`run_game_loop()`を追加

## 理由

### 単一責任原則（SRP）の遵守
- `main.c`: アプリケーション全体のフロー制御
- `engine/game_loop.c`: ゲームループとイベント管理
- 各モジュールが明確な責務を持つ

### 依存性逆転原則（DI）の改善
- `main.c`はエンジンの詳細（MLXイベントフック）を知る必要がない
- エンジンモジュールが自身の初期化と実行を管理
- 抽象レベルの分離が明確になる

### 保守性の向上
- イベントハンドラの追加・変更が`game_loop.c`内で完結
- `main.c`はビジネスロジックの流れを読みやすく表現
- テストの容易性が向上（モジュール単位でのテストが可能）

### 拡張性の向上
- 将来的に複数のゲームモードやメニュー画面を追加する際、
  `run_game_loop()`の内部実装を変更するだけで対応可能

## 結果

### ポジティブな結果

- **可読性の向上**: `main.c`が高レベルのフローを明確に表現
- **責務の分離**: 各モジュールの役割が明確になる
- **保守性の向上**: イベント処理の変更がエンジンモジュール内で完結
- **テスタビリティの向上**: モジュール単位でのテストが容易
- **パートナーとの分業が容易**: パーサー部分とエンジン部分の境界が明確

### ネガティブな結果

- **ファイル数の増加**: 新規ファイル（`game_loop.c`）が1つ追加される
- **関数呼び出しの増加**: 直接的な呼び出しから間接的な呼び出しになる（ただし、パフォーマンス影響は無視できる程度）
- **初見時の理解コスト**: 処理の流れを追うために複数ファイルを参照する必要がある

## 代替案

| 代替案 | メリット | デメリット | 不採用理由 |
|--------|----------|------------|-----------|
| 現状維持（main.cにすべて記述） | ファイル数が少ない、処理が1ファイルで完結 | 責務が過剰、保守性が低い、拡張が困難 | 長期的な保守性を優先 |
| すべてをengine/init_game.cに移動 | main.cが簡潔になる | init関数が初期化以上の責務を持つことになる | 関数名と実際の動作が乖離する |
| game構造体にrun()メソッドを追加（オブジェクト指向的） | カプセル化が強化される | Cでは構造体にメソッドという概念がない、関数ポインタを使うと複雑化 | C言語の慣習に従う |

## 関連

- [ADR-0001: ADRを用いた意思決定の記録](./0001-example.md)
- [エンジンモジュール設計](../design/modules/engine/design.md)
- [アーキテクチャ設計](../design/architecture.md)

## 注記

このリファクタリングは、パーサーの実装とは独立して進められる。パートナーがパーサー部分を実装中でも、エンジン部分のリファクタリングは影響を与えない。

実装時には以下の点に注意：
- 既存の`handle_keypress`, `close_window`, `render_frame`は変更しない
- `cleanup_game()`の呼び出しタイミングは`mlx_loop()`終了後を維持
- クロスプラットフォーム対応（macOS/Linux）を考慮

---

**作成日**: 2025-11-28
**作成者**: mkawano (with AI assistance)
