# ADR-0005: world_map配列インデックスの修正

## ステータス

**承認済み** (2025-12-20)

## コンテキスト

プレイヤー移動時に「カニ歩き」現象が発生していた。具体的には：

1. 廊下の中央でWキー（前進）を押すと、前に進まず横方向に移動する
2. 画面上「前方が開けている」ように見えても、実際には壁に向かって移動している
3. 移動方向と視覚的な見た目が一致しない

### 調査結果

デバッグログとコード調査により、以下の問題が判明：

**配列宣言**：
```c
int world_map[MAP_HEIGHT][MAP_WIDTH];  // [行][列] = [y][x]
```

**正しいアクセス方法**: `world_map[y座標][x座標]`

**実装状況**：
- `player_movement.c` (line 170-177): `world_map[y1][x1]` ✓ **正しい**
- `ray_dda.c` (line 35): `world_map[ray->map_x][ray->map_y]` ✗ **間違い**

### 影響

1. **レイキャスティング**は転置されたマップを読んでいた
   - プレイヤーが見る画面は実際のマップと90度回転した状態
   - 北壁が南壁として、東壁が西壁として表示される可能性
2. **移動の当たり判定**は正しいマップを読んでいた
   - 移動は正しいマップの壁を避ける
3. **結果**：
   - 画面上「前」に見える方向と実際の進行方向が一致しない
   - プレイヤーは「前方が開けている」と思っても、実際の方向ベクトルは壁に向いている
   - 壁にぶつかり、スライド処理で横方向に動く = 「カニ歩き」

### デバッグログからの証拠

```
[W] pos(3.12,5.27) dir(-0.04,-1.00) new(3.12,5.17)
```

- 方向ベクトル: (-0.04, -1.00) - ほぼY軸負の方向
- マップ上では縦方向の廊下（実際）
- しかし画面上では横方向の廊下に見えていた（転置されたマップの表示）
- プレイヤーは横方向に進もうとするが、実際には縦方向の壁に当たる

## 検討した選択肢

### 選択肢 1: player_movement.cのインデックスを変更（不採用）

**理由**:
- player_movement.cは正しい実装
- world_mapの宣言に合致している
- 変更すると移動の当たり判定が壊れる

### 選択肢 2: ray_dda.cのインデックスを修正（採用）

**メリット**:
- 1行の修正で済む
- world_mapの宣言に合致する
- レイキャスティングと移動が同じマップを参照する

**デメリット**:
- なし（明白なバグ修正）

### 選択肢 3: world_mapの宣言を変更（不採用）

**理由**:
- 影響範囲が大きすぎる
- 標準的な2次元配列の慣例に反する
- 既存の正しいコードを壊す

## 決定

**選択肢 2を採用**: `ray_dda.c`の35行目のインデックスを修正する。

### 修正内容

**ファイル**: `srcs/engine/raycasting/ray_dda.c`

**変更箇所**: line 35

**変更前**:
```c
if (game->world_map[ray->map_x][ray->map_y] > 0)
    ray->hit = 1;
```

**変更後**:
```c
if (game->world_map[ray->map_y][ray->map_x] > 0)
    ray->hit = 1;
```

### 修正理由

- `world_map[MAP_HEIGHT][MAP_WIDTH]`は`[行][列]`の順で宣言されている
- 行 = Y座標、列 = X座標
- したがって正しいアクセスは`world_map[y][x]`
- `map_y`が行インデックス、`map_x`が列インデックス
- 現在の`[map_x][map_y]`は逆で、転置されたマップを読んでいた

## 結果

### 正の影響

1. **「カニ歩き」バグの解消**:
   - プレイヤーの移動方向と視覚的な見た目が一致
   - 前進キーで前に進む、横移動キーで横に進む

2. **テクスチャの方向が正しくなる**:
   - 北壁には北向きテクスチャが表示される
   - 各方向の壁に正しいテクスチャが表示される

3. **プレイヤーの初期向きが視覚と一致**:
   - `init_player()`で設定した`dir(-1.0, 0.0)`（北向き）が実際に北を向く

4. **回転動作が視覚と一致**:
   - 左回転すると実際に画面も左に回転する
   - 方向感覚が正しく機能する

### 負の影響

- なし（バグ修正）

### リスク評価

- **変更箇所**: 1ファイル、1行のみ
- **変更内容**: 配列インデックスの順序修正
- **影響範囲**: レイキャスティングの壁検出のみ
- **副作用の可能性**: 極めて低い
- **確実性**: 極めて高い（明白なバグ）

## 関連決定

- [ADR-0004: テクスチャマッピングの実装方針](./0004-texture-mapping-implementation.md)
  - テクスチャの方向選択ロジックが正しく機能するようになる
- [ADR-0006: スマート壁スライディングの実装](./0006-smart-wall-sliding-implementation.md)
  - この修正後に壁スライディングロジックを改善

## 参照

- [raycasting モジュール設計](../design/modules/engine/raycasting/design.md)
- [player モジュール設計](../design/modules/engine/player/design.md)
- バグ報告: ユーザーからの「カニ歩き」報告

## メモ

### 実装後の改善履歴

- **2025-12-20**: バグ修正実装
  - ray_dda.cの配列インデックスを修正
  - ビルド成功、動作確認完了
  - 「カニ歩き」現象の解消を確認

### 根本原因分析

このバグが長期間発見されなかった理由：
1. **症状が複雑**: 「カニ歩き」という現象は、複数の要因（壁衝突、スライド処理）が組み合わさった結果
2. **部分的には動作**: 一部の移動は正しく見えていた
3. **マップの対称性**: テストマップが部分的に対称だと、転置の影響が見えにくい

### 教訓

1. **配列のインデックス順序は重要**:
   - 2次元配列は`[行][列]`の順序が標準
   - マップ座標は`[y][x]`でアクセスすべき
2. **一貫性の確保**:
   - すべてのコードで同じインデックス順序を使用する
   - コードレビューで配列アクセスパターンを確認
3. **デバッグログの重要性**:
   - 位置と方向ベクトルのログが問題特定に役立った
   - 座標系の理解が問題解決の鍵だった

### 今後の予防策

1. **コメントの追加**: 配列宣言に順序を明記
   ```c
   int world_map[MAP_HEIGHT][MAP_WIDTH];  // [y][x] = [row][col]
   ```
2. **ヘルパーマクロの検討** (将来の拡張):
   ```c
   #define MAP_AT(map, x, y) ((map)[(y)][(x)])
   ```
3. **テストケースの追加**: 非対称なマップでのテスト
