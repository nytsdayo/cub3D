name: Norminette Auto-Fix

# Security Note: This workflow uses workflow_run to trigger after the Norminette Check.
# It explicitly validates that PRs are from the same repository (not forks) before
# checking out any code. The fix script is inline in this workflow file and does not
# execute any code from the checked-out repository.

on:
  workflow_run:
    workflows: ["Norminette Check"]
    types:
      - completed

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    # Only run if the Norminette Check workflow failed
    if: github.event.workflow_run.conclusion == 'failure'
    permissions:
      contents: write
      pull-requests: write

    steps:
      # This step validates the PR source BEFORE any code checkout.
      # Fork PRs are explicitly rejected to prevent untrusted code execution.
      - name: Get PR information
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run;
            
            // Check if triggered by github-actions[bot]
            if (workflowRun.actor && workflowRun.actor.login === 'github-actions[bot]') {
              console.log('Skipping: triggered by github-actions[bot]');
              return { skip: true };
            }
            
            // Find the associated pull request
            const prs = workflowRun.pull_requests;
            if (!prs || prs.length === 0) {
              console.log('No pull request associated with this workflow run.');
              return { skip: true };
            }
            
            const pr = prs[0];
            
            // Get full PR details to check if it's from a fork
            const prDetails = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const headRepo = prDetails.data.head.repo.full_name;
            const baseRepo = prDetails.data.base.repo.full_name;
            
            // Exclude fork-origin PRs
            if (headRepo !== baseRepo) {
              console.log(`Skipping: PR is from a fork (${headRepo} != ${baseRepo})`);
              return { skip: true };
            }
            
            console.log(`Processing PR #${pr.number} from branch ${prDetails.data.head.ref}`);
            return {
              skip: false,
              pr_number: pr.number,
              head_ref: prDetails.data.head.ref,
              head_sha: prDetails.data.head.sha
            };

      - name: Check if should proceed
        id: check
        run: |
          RESULT='${{ steps.get-pr.outputs.result }}'
          SKIP=$(echo "$RESULT" | jq -r '.skip')
          if [ "$SKIP" = "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "pr_number=$(echo "$RESULT" | jq -r '.pr_number')" >> $GITHUB_OUTPUT
            echo "head_ref=$(echo "$RESULT" | jq -r '.head_ref')" >> $GITHUB_OUTPUT
            echo "head_sha=$(echo "$RESULT" | jq -r '.head_sha')" >> $GITHUB_OUTPUT
          fi

      - name: Checkout PR branch
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.check.outputs.head_ref }}
          fetch-depth: 0

      - name: Set up Python
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        if: steps.check.outputs.skip != 'true'
        run: |
          python3 -m pip install --upgrade pip setuptools
          python3 -m pip install norminette
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run formatting fixes (inline)
        if: steps.check.outputs.skip != 'true'
        run: |
          # Skip execution if triggered by github-actions[bot]
          if [ "${GITHUB_ACTOR:-}" = "github-actions[bot]" ]; then
              echo "Skipping auto-fix: triggered by github-actions[bot] to avoid loops."
              exit 0
          fi

          # Find all tracked .c and .h files in srcs/ and includes/ (matching norminette.yml)
          FILES=$(git ls-files 'srcs/*.c' 'srcs/**/*.c' 'srcs/*.h' 'srcs/**/*.h' 'includes/*.c' 'includes/**/*.c' 'includes/*.h' 'includes/**/*.h' 2>/dev/null || true)

          if [ -z "$FILES" ]; then
              echo "No .c or .h files found in the repository."
              exit 0
          fi

          echo "Processing the following files:"
          echo "$FILES"
          echo ""

          for file in $FILES; do
              if [ -f "$file" ]; then
                  echo "Fixing: $file"

                  # a) Convert leading 4 spaces to tabs (Norminette requires tabs for indentation)
                  # First, normalize any existing leading spaces to tabs
                  perl -i -pe 's/^(    )+/"\t" x (length($&)\/4)/ge' "$file"

                  # b) Remove trailing whitespace
                  sed -i 's/[[:space:]]*$//' "$file"

                  # c) Ensure a newline at EOF
                  if [ -s "$file" ] && [ "$(tail -c 1 "$file" | wc -l)" -eq 0 ]; then
                      echo "" >> "$file"
                  fi

                  # d) Apply clang-format
                  if command -v clang-format &> /dev/null; then
                      clang-format -i "$file"
                  else
                      echo "Warning: clang-format not found, skipping clang-format step for $file"
                  fi
              fi
          done

          echo ""
          echo "Formatting fixes applied successfully."

      - name: Create Pull Request with fixes
        if: steps.check.outputs.skip != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "style: auto-fix formatting for Norminette compliance"
          branch: auto-fix/norminette-${{ steps.check.outputs.pr_number }}
          delete-branch: true
          title: "[Auto-Fix] Norminette formatting fixes for PR #${{ steps.check.outputs.pr_number }}"
          body: |
            ## Automated Formatting Fixes

            This PR contains automated formatting fixes to help with Norminette compliance.

            **Fixes applied:**
            - ✅ Converted leading spaces to tabs (Norminette requires tabs)
            - ✅ Removed trailing whitespace
            - ✅ Ensured newline at end of files
            - ✅ Applied clang-format

            **Original PR:** #${{ steps.check.outputs.pr_number }}

            > ⚠️ **Note:** These are safe, mechanical formatting changes. Please review and merge if the changes look correct.
          labels: |
            automated
            style
